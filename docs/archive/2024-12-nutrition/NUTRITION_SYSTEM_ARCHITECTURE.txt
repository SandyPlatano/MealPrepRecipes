================================================================================
        MEALPREP NUTRITION SYSTEM - ARCHITECTURE & DATA FLOW ANALYSIS
================================================================================

================================================================================
SYSTEM ARCHITECTURE OVERVIEW
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NUTRITION DATA FLOW                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  User Input (Recipe)                                                        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚  POST /api/ai/extract-nutrition         â”‚                               â”‚
â”‚  â”‚  - recipe_id, ingredients, servings     â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Validation & Rate Limiting                                     â”‚        â”‚
â”‚  â”‚  - Authentication check                                         â”‚        â”‚
â”‚  â”‚  - Rate limit (30 req/hr per user)                             â”‚        â”‚
â”‚  â”‚  - Recipe ownership verification                               â”‚        â”‚
â”‚  â”‚  - Check for existing nutrition data                           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  buildNutritionExtractionPrompt()                               â”‚        â”‚
â”‚  â”‚  (nutrition-extraction-prompt.ts:32-93)                        â”‚        â”‚
â”‚  â”‚  - Ingredients list                                             â”‚        â”‚
â”‚  â”‚  - Servings information                                         â”‚        â”‚
â”‚  â”‚  - Cooking instructions (optional)                             â”‚        â”‚
â”‚  â”‚  - Recipe title (optional)                                     â”‚        â”‚
â”‚  â”‚  - Confidence scoring guidelines (INSTRUCTIONS ONLY)           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Claude Sonnet 4.5 API Call                                     â”‚        â”‚
â”‚  â”‚  - Prompt sent to Claude                                        â”‚        â”‚
â”‚  â”‚  - Returns JSON: nutrition + confidence_score                  â”‚        â”‚
â”‚  â”‚  - Max tokens: 1000                                             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  parseNutritionResponse()                                       â”‚        â”‚
â”‚  â”‚  (nutrition-extraction-prompt.ts:180-221)                      â”‚        â”‚
â”‚  â”‚  - Parse JSON response                                          â”‚        â”‚
â”‚  â”‚  - Validate calories field                                      â”‚        â”‚
â”‚  â”‚  - Validate confidence_score field                             â”‚        â”‚
â”‚  â”‚  - Clamp confidence to 0-1 range                               â”‚        â”‚
â”‚  â”‚  - Round values to expected decimals                           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  validateNutritionRanges()    ğŸ› BUG: Zero calories validation  â”‚        â”‚
â”‚  â”‚  (nutrition-extraction-prompt.ts:239-317)                      â”‚        â”‚
â”‚  â”‚  - Calorie range: 10-2000                                      â”‚        â”‚
â”‚  â”‚  - Protein range: 0-200g                                       â”‚        â”‚
â”‚  â”‚  - Carbs range: 0-300g                                         â”‚        â”‚
â”‚  â”‚  - Fat range: 0-150g                                           â”‚        â”‚
â”‚  â”‚  - Fiber â‰¤ Carbs âœ“                                             â”‚        â”‚
â”‚  â”‚  - Sugar â‰¤ Carbs âœ“                                             â”‚        â”‚
â”‚  â”‚  - Sugar + Fiber â‰¤ Carbs âœ“                                     â”‚        â”‚
â”‚  â”‚  - Calorie-macro mismatch < 20%                                â”‚        â”‚
â”‚  â”‚  - Sodium range: 0-5000mg                                      â”‚        â”‚
â”‚  â”‚  Returns: Array of warnings                                    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  [CURRENT SYSTEM] Confidence Determination                      â”‚        â”‚
â”‚  â”‚  (extract-nutrition/route.ts:274-279)                          â”‚        â”‚
â”‚  â”‚                                                                  â”‚        â”‚
â”‚  â”‚  confidence_level = {                                           â”‚        â”‚
â”‚  â”‚    score >= 0.7  â†’ "high"                                      â”‚        â”‚
â”‚  â”‚    score >= 0.4  â†’ "medium"                                    â”‚        â”‚
â”‚  â”‚    else          â†’ "low"                                       â”‚        â”‚
â”‚  â”‚  }                                                               â”‚        â”‚
â”‚  â”‚                                                                  â”‚        â”‚
â”‚  â”‚  âŒ WARNINGS ARE IGNORED FOR CONFIDENCE                        â”‚        â”‚
â”‚  â”‚  âŒ THRESHOLDS ARE HARDCODED                                   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Save to Database                                               â”‚        â”‚
â”‚  â”‚  - recipe_nutrition table                                      â”‚        â”‚
â”‚  â”‚  - Stores: all nutrition fields + confidence_score             â”‚        â”‚
â”‚  â”‚  - API tracking: input_tokens, output_tokens, cost_usd         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Return Response to Client                                      â”‚        â”‚
â”‚  â”‚  - success: boolean                                             â”‚        â”‚
â”‚  â”‚  - nutrition: RecipeNutrition                                  â”‚        â”‚
â”‚  â”‚  - warnings: string[] (if any)                                 â”‚        â”‚
â”‚  â”‚  - confidence_level: "high" | "medium" | "low"                â”‚        â”‚
â”‚  â”‚  - cost: {input_tokens, output_tokens, cost_usd}              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†“                                                                      â”‚
â”‚  User Interface                                                             â”‚
â”‚  - Shows nutrition data with warnings                                      â”‚
â”‚  - Shows confidence level (may not match actual data quality)             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
NUTRITION CALCULATION SYSTEM
================================================================================

For Aggregation (multiple recipes/days):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  sumNutrition() & averageNutrition()                  â”‚
â”‚              (calculations.ts:23-174)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  INPUT: Array of NutritionData items                                 â”‚
â”‚  [                                                                   â”‚
â”‚    { calories: 100, carbs: 50, protein: 20 },                       â”‚
â”‚    { calories: null, carbs: null, protein: 30 },                    â”‚
â”‚    { calories: 0, carbs: 0, protein: 0 }                            â”‚
â”‚  ]                                                                   â”‚
â”‚                                                                        â”‚
â”‚  PROCESSING (Per-Field Counting):                                    â”‚
â”‚                                                                        â”‚
â”‚  Calories:    [100, null, 0]      â†’ Count=2  Sum=100  Avg=50   âœ“    â”‚
â”‚  Carbs:       [50, null, 0]       â†’ Count=2  Sum=50   Avg=25   âœ“    â”‚
â”‚  Protein:     [20, 30, 0]         â†’ Count=3  Sum=50   Avg=16.7 âœ“    â”‚
â”‚                                                                        â”‚
â”‚  KEY: Each field has separate counter!                               â”‚
â”‚       Null values skipped per-field                                  â”‚
â”‚       Zero values counted as valid                                   â”‚
â”‚                                                                        â”‚
â”‚  OUTPUT:                                                             â”‚
â”‚                                                                        â”‚
â”‚  sumNutrition():                                                     â”‚
â”‚    { calories: 100, carbs: 50, protein: 50 }                        â”‚
â”‚                                                                        â”‚
â”‚  averageNutrition():                                                 â”‚
â”‚    { calories: 50, carbs: 25, protein: 16.7 }                       â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


For Scaling (different serving sizes):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         scaleNutrition()                              â”‚
â”‚              (calculations.ts:184-223)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  Base Recipe (1 serving):                                            â”‚
â”‚    calories: 100, protein: 10, carbs: 20, fat: 5                    â”‚
â”‚                                                                        â”‚
â”‚  Scale Scenarios:                                                    â”‚
â”‚                                                                        â”‚
â”‚  1. Scale to 0 servings                                              â”‚
â”‚     âœ“ Returns all zeros (valid, represents 0 food)                  â”‚
â”‚     { calories: 0, protein: 0, carbs: 0, fat: 0 }                  â”‚
â”‚                                                                        â”‚
â”‚  2. Scale to negative servings                                       â”‚
â”‚     âœ“ Returns original (guard against invalid input)                â”‚
â”‚     { calories: 100, protein: 10, carbs: 20, fat: 5 }              â”‚
â”‚                                                                        â”‚
â”‚  3. Scale to 0.5 servings                                            â”‚
â”‚     âœ“ Scales correctly with precision                               â”‚
â”‚     { calories: 50, protein: 5, carbs: 10, fat: 2.5 }              â”‚
â”‚                                                                        â”‚
â”‚  4. Scale to 100 servings                                            â”‚
â”‚     âœ“ Works for extreme scaling                                     â”‚
â”‚     { calories: 10000, protein: 1000, carbs: 2000, fat: 500 }      â”‚
â”‚                                                                        â”‚
â”‚  Formula:                                                            â”‚
â”‚    scale_factor = target_servings / base_servings                   â”‚
â”‚    new_value = old_value * scale_factor                             â”‚
â”‚    Rounded to 1 decimal for grams, whole for mg                     â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
CONFIDENCE SCORING SYSTEM - CURRENT VS RECOMMENDED
================================================================================

CURRENT SYSTEM (Has Gaps):

  Claude API Response
       â†“
  { confidence_score: 0.85 }
       â†“
  validateNutritionRanges()
       â†“
  Returns: ["Calorie mismatch: 240%", "Protein very high"]  â† WARNINGS
       â†“
  âŒ Confidence determination ignores warnings
       â†“
  confidence_level = 0.85 >= 0.7 ? "HIGH" : ...
       â†“
  Response with HIGH confidence despite 2 warnings! âŒ


RECOMMENDED SYSTEM (Fixes Issues):

  Claude API Response
       â†“
  { confidence_score: 0.85 }
       â†“
  validateNutritionRanges() âœ“ (with zero calories fix)
       â†“
  Returns: ["Calorie mismatch: 240%", "Protein very high"]
       â†“
  calculateConfidencePenalties()
       â†“
  warnings: 10% penalty (2 warnings Ã— 5%)
  mismatch:  10% penalty (>20% mismatch)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total penalty: 20%
       â†“
  adjusted_confidence = 0.85 - 0.20 = 0.65
       â†“
  confidence_level = 0.65 >= 0.7 ? "HIGH" : "MEDIUM" â†’ MEDIUM âœ“
       â†“
  Response with MEDIUM confidence (matches actual quality) âœ“


PENALTY BREAKDOWN:

  Penalty Sources (max 40% total):
  â”œâ”€ Warnings: 5% per warning (max 20%)
  â”œâ”€ Calorie-macro mismatch: 10% if >20%, 5% if >10%
  â”œâ”€ Zero macros: 15% if 2+ zero values
  â””â”€ Missing fields: Up to 15% for incomplete data

  Example:
    Original confidence: 0.85
    Warnings (1): -5%
    Mismatch (240%): -10%
    Zero carbs: -15%
    Missing fiber: -5%
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Total penalty: -35%
    Adjusted confidence: 0.50 â†’ "MEDIUM" (more honest)


================================================================================
VALIDATION CONSTRAINT MATRIX
================================================================================

Constraint Type    Current Check      Status    Example Trigger
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Calories          10 â‰¤ cal â‰¤ 2000    âš ï¸ ğŸ›   cal=0, protein=30 (BUG)
Protein           0 â‰¤ p â‰¤ 200        âœ“        protein=250
Carbs             0 â‰¤ c â‰¤ 300        âœ“        carbs=400
Fat               0 â‰¤ f â‰¤ 150        âœ“        fat=200
Fiber             fiber â‰¤ carbs      âœ“        fiber=60, carbs=50
Sugar             sugar â‰¤ carbs      âœ“        sugar=60, carbs=50
Sugar+Fiber       (s+f) â‰¤ carbs      âœ“        s=40, f=20, c=50
Sodium            0 â‰¤ na â‰¤ 5000      âœ“        sodium=6000
Calorie-Macro     |estimated - actual|/actual < 20%  âœ“

Validation Examples:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PASS: carbs=50, fiber=25, sugar=25
      25+25=50, exactly at limit

PASS: carbs=50, fiber=10, sugar=15
      10+15=25, under limit

FAIL: carbs=50, fiber=26, sugar=25
      26+25=51, exceeds limit
      Warning: "Sugar and fiber combined cannot exceed total carbs"

BUG:  carbs=0, fiber=0, sugar=0
      Currently valid, but should be valid (all zeros = no data)

BUG:  calories=0, protein=30, carbs=50, fat=20
      Currently passes, but zero calorie with macros is impossible!
      Should warn: "Calories cannot be 0 when macros are provided"


================================================================================
EDGE CASE HANDLING MATRIX
================================================================================

Edge Case                Input                            Current Status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Zero calories           {cal: 0, protein: 30}            âŒ BUG (skipped)
Zero values mix         {cal: 0, protein: null}          âœ“ Handled correctly
All null               {cal: null, all others: null}     âœ“ Returns null values
Extreme values         {cal: 10000, protein: 500}        âœ“ Multiple warnings
Calorie mismatch       {cal: 500, p: 100, c: 100}       âœ“ Warns at >20% diff
Fiber > carbs          {fiber: 60, carbs: 50}           âœ“ Warns
Sugar > carbs          {sugar: 60, carbs: 50}           âœ“ Warns
Negative values        {protein: -10}                    âœ“ Warns
Missing fields         {cal: 100, others: null}          Partial (see #6)
High completeness      {cal: 100, protein: 10}          âš ï¸ No bonus (recommend)


================================================================================
FILE DEPENDENCY GRAPH
================================================================================

extract-nutrition/route.ts  (API endpoint)
  â”œâ”€ Imports: buildNutritionExtractionPrompt()
  â”œâ”€ Imports: parseNutritionResponse()
  â”œâ”€ Imports: validateNutritionRanges()
  â”œâ”€ Uses: Claude API
  â””â”€ Saves to: recipe_nutrition table
      â”œâ”€ confidence_score (from Claude, NOT adjusted)
      â”œâ”€ warnings (collected but not used for scoring)
      â””â”€ input/output tokens for cost tracking

nutrition-extraction-prompt.ts  (Prompt builder & validators)
  â”œâ”€ buildNutritionExtractionPrompt() â†’ returns prompt
  â”œâ”€ buildQuickNutritionPrompt() â†’ simplified version
  â”œâ”€ buildNutritionValidationPrompt() â†’ validation prompt
  â”œâ”€ parseNutritionResponse() â†’ parses JSON
  â””â”€ validateNutritionRanges() â†’ returns warnings
      â”œâ”€ Calorie validation (ğŸ› zero bug)
      â”œâ”€ Macro validation (âœ“ correct)
      â”œâ”€ Calorie-macro matching (skipped if cal=0)
      â”œâ”€ Fiber constraints (âœ“ correct)
      â”œâ”€ Sugar constraints (âœ“ correct)
      â””â”€ Sodium validation (âœ“ correct)

calculations.ts  (Nutrition math functions)
  â”œâ”€ sumNutrition() âœ“
  â”œâ”€ averageNutrition() âœ“
  â”œâ”€ scaleNutrition() âœ“
  â”œâ”€ calculateMacroProgress()
  â”œâ”€ calculateAllMacroProgress()
  â”œâ”€ calculateDailyMacroSummary()
  â”œâ”€ calculateWeeklyMacroDashboard()
  â”œâ”€ calculateDataCompleteness()
  â”œâ”€ isNutritionComplete()
  â””â”€ isMacroDistributionBalanced()

nutrition.ts (Server actions)
  â”œâ”€ getRecipeNutrition()
  â”œâ”€ updateRecipeNutrition()
  â”œâ”€ deleteRecipeNutrition()
  â”œâ”€ getBulkRecipeNutrition()
  â”œâ”€ getDailyNutritionSummary()
  â”œâ”€ getWeeklyNutritionDashboard()
  â””â”€ saveDailyNutritionLog()


================================================================================
IMPACT ANALYSIS: PROPOSED FIXES
================================================================================

FIX #1: Zero Calories Bug (1 hour)
  Impact:    CRITICAL
  Risk:      LOW (only affects edge case)
  Benefits:
    âœ“ Catches invalid data (0 cal + macros)
    âœ“ Enables calorie-macro check for zero values
    âœ“ Improves data quality validation

FIX #2: Confidence Penalty System (2 hours)
  Impact:    CRITICAL
  Risk:      MEDIUM (changes confidence scores)
  Benefits:
    âœ“ Confidence reflects actual data quality
    âœ“ Warnings integrated into scoring
    âœ“ More honest confidence reporting
    âœ“ Easier to identify questionable nutrition data
  Mitigation:
    - Confidence scores will be lower for problematic data
    - This is GOOD, makes system more conservative
    - UI should handle medium/low confidence gracefully

FIX #3: Configurable Thresholds (30 min)
  Impact:    MEDIUM
  Risk:      LOW (backward compatible with defaults)
  Benefits:
    âœ“ Flexibility for different use cases
    âœ“ Can adjust without code changes

FIX #4: Additional Validations (45 min)
  Impact:    LOW
  Risk:      LOW
  Benefits:
    âœ“ Better guidance for unusual recipes
    âœ“ More detailed warnings


TOTAL EFFORT: ~4 hours development + ~2 hours testing = 6 hours
RISK LEVEL: LOW to MEDIUM (mostly backward compatible)
TESTING: Verify on 100+ existing recipes


================================================================================
RECOMMENDATIONS PRIORITY
================================================================================

THIS SPRINT (Critical):
  1. Fix zero calories validation bug
  2. Implement confidence penalty system
  3. Deploy and test on staging

NEXT SPRINT (Important):
  1. Make thresholds configurable
  2. Add fiber/sugar balance check
  3. Improve sodium validation

FUTURE (Nice to have):
  1. Confidence breakdown reporting in UI
  2. Analytics on confidence distribution
  3. User feedback on confidence accuracy
  4. Machine learning to improve confidence prediction


================================================================================
END ARCHITECTURE DOCUMENT
================================================================================

This document shows:
- Current system flow and issues
- How calculations work correctly
- Where validation gaps exist
- Confidence scoring problems
- Recommended fixes

For code changes, see: NUTRITION_FIXES_RECOMMENDED.md
For test results, see: NUTRITION_SYSTEM_TEST_REPORT.md
For summary, see: NUTRITION_FINDINGS_SUMMARY.txt
