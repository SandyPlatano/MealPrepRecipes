<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#3b82f6">
  <meta name="description" content="Shopping List | Babe, What's for Dinner?">
  <title>Shopping List | Babe, What's for Dinner?</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --background: 0 0% 100%;
      --foreground: 0 0% 3.9%;
      --primary: 221 83% 53%;
      --primary-hex: #3b82f6;
      --muted: 0 0% 96.1%;
      --muted-hex: #f5f5f5;
      --muted-foreground: 0 0% 45.1%;
      --muted-foreground-hex: #737373;
      --border: 0 0% 89.8%;
      --border-hex: #e5e5e5;
      --radius: 0.5rem;
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --background: 0 0% 3.9%;
        --foreground: 0 0% 98%;
        --muted: 0 0% 14.9%;
        --muted-hex: #262626;
        --muted-foreground: 0 0% 63.9%;
        --muted-foreground-hex: #a3a3a3;
        --border: 0 0% 14.9%;
        --border-hex: #262626;
      }
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background-color: hsl(var(--background));
      color: hsl(var(--foreground));
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding-top: var(--safe-area-top);
      padding-bottom: var(--safe-area-bottom);
      min-height: 100vh;
      min-height: 100dvh;
    }
    
    /* Offline indicator */
    .offline-indicator {
      background: #fef3c7;
      border-bottom: 2px solid #f59e0b;
      color: #92400e;
      padding: 12px 16px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      display: none;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .offline-indicator.show {
      display: block;
    }
    
    @media (prefers-color-scheme: dark) {
      .offline-indicator {
        background: #78350f;
        border-bottom-color: #f59e0b;
        color: #fef3c7;
      }
    }
    
    /* Header */
    .header {
      background: hsl(var(--background));
      border-bottom: 1px solid hsl(var(--border));
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background-color: hsl(var(--background) / 0.95);
    }
    
    .header h1 {
      font-family: 'JetBrains Mono', 'Fira Code', Consolas, Monaco, monospace;
      font-size: 20px;
      font-weight: 700;
      color: hsl(var(--foreground));
      letter-spacing: -0.02em;
      margin-bottom: 4px;
    }
    
    .header .subtitle {
      font-size: 14px;
      color: hsl(var(--muted-foreground));
      font-family: 'Inter', system-ui, sans-serif;
    }
    
    /* Progress bar */
    .progress-container {
      padding: 16px 20px;
      background: hsl(var(--background));
      border-bottom: 1px solid hsl(var(--border));
      position: sticky;
      top: calc(73px + var(--safe-area-top));
      z-index: 40;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: hsl(var(--muted));
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary-hex);
      transition: width 0.3s ease-out;
      border-radius: 4px;
    }
    
    .progress-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: hsl(var(--muted-foreground));
      text-align: center;
    }
    
    /* Main content */
    .content {
      padding: 0 20px 100px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Category section */
    .category-section {
      margin: 24px 0;
    }
    
    .category-header {
      font-family: 'JetBrains Mono', 'Fira Code', Consolas, Monaco, monospace;
      font-size: 16px;
      font-weight: 600;
      color: hsl(var(--foreground));
      letter-spacing: -0.02em;
      padding-bottom: 8px;
      border-bottom: 2px solid hsl(var(--foreground));
      margin-bottom: 12px;
    }
    
    /* Shopping list item */
    .list-item {
      display: flex;
      align-items: center;
      min-height: 48px;
      padding: 12px 16px;
      margin: 4px 0;
      background: hsl(var(--background));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    
    .list-item:active {
      transform: scale(0.98);
      background: hsl(var(--muted));
    }
    
    .list-item.checked {
      opacity: 0.6;
      text-decoration: line-through;
      color: hsl(var(--muted-foreground));
    }
    
    .checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border: 2px solid hsl(var(--border));
      border-radius: 4px;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      background: hsl(var(--background));
    }
    
    .list-item.checked .checkbox {
      background: var(--primary-hex);
      border-color: var(--primary-hex);
    }
    
    .checkbox::after {
      content: '';
      width: 6px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      display: none;
    }
    
    .list-item.checked .checkbox::after {
      display: block;
    }
    
    .item-text {
      font-size: 16px;
      font-weight: 500;
      color: hsl(var(--foreground));
      flex: 1;
      line-height: 1.5;
    }
    
    .list-item.checked .item-text {
      color: hsl(var(--muted-foreground));
    }
    
    /* Completed section */
    .completed-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid hsl(var(--border));
    }
    
    .completed-section .category-header {
      opacity: 0.7;
    }
    
    /* Fixed bottom bar */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: hsl(var(--background));
      border-top: 1px solid hsl(var(--border));
      padding: 12px 20px;
      padding-bottom: calc(12px + var(--safe-area-bottom));
      display: flex;
      gap: 12px;
      z-index: 100;
      box-shadow: 0 -4px 12px hsl(var(--foreground) / 0.05);
    }
    
    .btn {
      flex: 1;
      min-height: 48px;
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: manipulation;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary-hex);
      color: white;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
      background: #2563eb;
    }
    
    .btn-secondary {
      background: hsl(var(--muted));
      color: hsl(var(--foreground));
    }
    
    .btn-secondary:active {
      background: hsl(var(--border));
    }
    
    /* Add item dialog */
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: hsl(var(--foreground) / 0.5);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .dialog-overlay.show {
      display: flex;
    }
    
    .dialog {
      background: hsl(var(--background));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .dialog h2 {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .dialog input,
    .dialog select {
      width: 100%;
      padding: 12px;
      border: 1px solid hsl(var(--border));
      border-radius: calc(var(--radius) - 2px);
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      margin-bottom: 16px;
    }
    
    .dialog-actions {
      display: flex;
      gap: 12px;
    }
    
    /* Loading/Error states */
    .loading, .error-state {
      text-align: center;
      padding: 60px 20px;
      color: hsl(var(--muted-foreground));
    }
    
    .error-state {
      color: #ef4444;
    }
    
    .error-state h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 24px 20px;
      color: hsl(var(--muted-foreground));
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      border-top: 1px solid hsl(var(--border));
      margin-top: 32px;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .list-item {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="offline-indicator" id="offlineIndicator">ðŸ“´ Offline â€“ changes saved locally</div>
  
  <header class="header">
    <h1>ðŸ›’ The List</h1>
    <div class="subtitle" id="weekRange">Loading...</div>
  </header>
  
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <div class="progress-text" id="progressText">0 of 0 grabbed</div>
  </div>
  
  <main class="content" id="mainContent">
    <div class="loading">Loading your list...</div>
  </main>
  
  <div class="bottom-bar">
    <button class="btn btn-primary" onclick="openAddDialog()">+ Add</button>
    <button class="btn btn-secondary" onclick="shareList()">Share</button>
  </div>
  
  <div class="dialog-overlay" id="addDialog" onclick="closeAddDialog(event)">
    <div class="dialog" onclick="event.stopPropagation()">
      <h2>Add Item</h2>
      <input type="text" id="newItemText" placeholder="e.g., Milk (1 gallon)" onkeydown="handleAddItemKeydown(event)">
      <select id="newItemCategory">
        <option value="">Aisle...</option>
      </select>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="closeAddDialog()">Cancel</button>
        <button class="btn btn-primary" onclick="addItem()">Add</button>
      </div>
    </div>
  </div>
  
  <footer class="footer">
    <div>Babe, What's for Dinner?</div>
    <div style="margin-top: 4px; font-size: 11px;">v1.0.0</div>
  </footer>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  
  <script>
    // Default Supabase credentials (fallback if not in URL)
    const DEFAULT_SUPABASE_URL = 'https://dqzalifzavpzvskkubal.supabase.co';
    const DEFAULT_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxemFsaWZ6YXZwenZza2t1YmFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Nzc5MTQsImV4cCI6MjA4MDM1MzkxNH0.qGGJdR1dU5KowI4L8pWez5_fZdsdLndK_Pu9Etd3uDs';
    
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const listId = urlParams.get('id');
    // Use URL params if provided, otherwise use defaults
    const supabaseUrl = urlParams.get('url') || DEFAULT_SUPABASE_URL;
    const supabaseKey = urlParams.get('key') || DEFAULT_SUPABASE_KEY;
    
    console.log('Shopping list init:', { listId, supabaseUrl: supabaseUrl ? 'set' : 'missing' });
    
    // State
    let state = {
      listId: listId,
      weekRange: '',
      items: [],
      schedule: [],
      categories: [],
      checkedItems: new Set(),
      supabase: null,
      offline: !navigator.onLine,
      supabaseUrl: supabaseUrl,
      supabaseKey: supabaseKey,
    };
    
    // Local storage key for this list
    const getStorageKey = () => `shopping-list-${state.listId}`;
    
    // Initialize
    async function init() {
      if (!listId) {
        showError('No list found', 'Use a valid link from your email.');
        return;
      }
      
      console.log('Loading shopping list:', listId);
      
      // Try to load from localStorage first (for offline support)
      loadFromLocalStorage();
      
      // Then try to load from Supabase
      await loadFromSupabase();
      
      // Set up offline detection
      window.addEventListener('online', handleOnline);
      window.addEventListener('offline', handleOffline);
      if (!navigator.onLine) handleOffline();
    }
    
    // Load from localStorage
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem(getStorageKey());
        if (saved) {
          const data = JSON.parse(saved);
          state.weekRange = data.weekRange || '';
          state.items = data.items || [];
          state.schedule = data.schedule || [];
          state.categories = data.categories || [];
          state.checkedItems = new Set(data.checkedItems || []);
          
          document.getElementById('weekRange').textContent = state.weekRange || 'The List';
          render();
          updateProgress();
        }
      } catch (e) {
        console.error('Error loading from localStorage:', e);
      }
    }
    
    // Save to localStorage
    function saveToLocalStorage() {
      try {
        const data = {
          weekRange: state.weekRange,
          items: state.items,
          schedule: state.schedule,
          categories: state.categories,
          checkedItems: Array.from(state.checkedItems),
        };
        localStorage.setItem(getStorageKey(), JSON.stringify(data));
      } catch (e) {
        console.error('Error saving to localStorage:', e);
      }
    }
    
    // Load from Supabase
    async function loadFromSupabase() {
      try {
        // Build Supabase REST API URL
        const apiUrl = `${state.supabaseUrl}/rest/v1/shopping_list_data?list_id=eq.${encodeURIComponent(listId)}&select=*`;
        
        console.log('Fetching from:', apiUrl);
        
        // Fetch list data from Supabase
        const response = await fetch(apiUrl, {
          headers: {
            'apikey': state.supabaseKey,
            'Authorization': `Bearer ${state.supabaseKey}`,
          }
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Supabase error:', errorText);
          throw new Error(`Failed to fetch list data: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Received data:', data);
        
        if (!data || data.length === 0) {
          console.log('No data found for list:', listId);
          // Check if we have local data
          if (state.items.length === 0) {
            showError('List not found', 'It may have expired or been deleted.');
          }
          return;
        }
        
        const listData = data[0];
        state.weekRange = listData.week_range || '';
        state.schedule = listData.schedule || [];
        
        // Parse items by category
        const itemsByCategory = listData.items_by_category || {};
        state.items = [];
        state.categories = [];
        
        for (const [category, items] of Object.entries(itemsByCategory)) {
          if (!state.categories.includes(category)) {
            state.categories.push(category);
          }
          
          items.forEach(itemText => {
            const itemId = btoa(unescape(encodeURIComponent(itemText))).replace(/[+/=]/g, '').substring(0, 20);
            state.items.push({
              id: itemId,
              text: itemText,
              category: category,
              checked: state.checkedItems.has(itemId),
            });
          });
        }
        
        // Load checked state from Supabase
        await loadCheckedState();
        
        document.getElementById('weekRange').textContent = state.weekRange || 'Shopping List';
        render();
        updateProgress();
        saveToLocalStorage();
        
      } catch (error) {
        console.error('Error loading from Supabase:', error);
        // If we have local data, continue with that
        if (state.items.length === 0) {
          showError('Couldn't load list', error.message);
        }
      }
    }
    
    // Load checked state from Supabase
    async function loadCheckedState() {
      try {
        const apiUrl = `${state.supabaseUrl}/rest/v1/shopping_list_state?list_id=eq.${encodeURIComponent(listId)}&select=item_id,checked`;
        const response = await fetch(apiUrl, {
          headers: {
            'apikey': state.supabaseKey,
            'Authorization': `Bearer ${state.supabaseKey}`,
          }
        });
        
        if (response.ok) {
          const stateData = await response.json();
          stateData.forEach(row => {
            if (row.checked) {
              state.checkedItems.add(row.item_id);
              const item = state.items.find(i => i.id === row.item_id);
              if (item) item.checked = true;
            }
          });
        }
      } catch (e) {
        console.error('Error loading checked state:', e);
      }
    }
    
    // Save checked state to Supabase
    async function saveCheckedState(item) {
      if (state.offline || !state.supabaseUrl || !state.supabaseKey) return;
      
      try {
        const apiUrl = `${state.supabaseUrl}/rest/v1/shopping_list_state`;
        await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'apikey': state.supabaseKey,
            'Authorization': `Bearer ${state.supabaseKey}`,
            'Content-Type': 'application/json',
            'Prefer': 'resolution=merge-duplicates',
          },
          body: JSON.stringify({
            list_id: state.listId,
            item_id: item.id,
            item_text: item.text,
            category: item.category,
            checked: item.checked,
            added_by_user: item.addedByUser || false,
          }),
        });
      } catch (e) {
        console.error('Error saving checked state:', e);
      }
    }
    
    // Show error
    function showError(title, message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="error-state">
          <h2>${escapeHtml(title)}</h2>
          <p>${escapeHtml(message)}</p>
        </div>
      `;
    }
    
    // Toggle item
    function toggleItem(itemId) {
      const item = state.items.find(i => i.id === itemId);
      if (!item) return;
      
      item.checked = !item.checked;
      
      if (item.checked) {
        state.checkedItems.add(itemId);
        if (navigator.vibrate) navigator.vibrate(10);
      } else {
        state.checkedItems.delete(itemId);
      }
      
      saveToLocalStorage();
      saveCheckedState(item);
      render();
      updateProgress();
    }
    
    // Add item
    function addItem() {
      const textInput = document.getElementById('newItemText');
      const categorySelect = document.getElementById('newItemCategory');
      
      const text = textInput.value.trim();
      const category = categorySelect.value || 'Other';
      
      if (!text) return;
      
      const itemId = 'user-' + Date.now() + '-' + Math.random().toString(36).substring(2, 8);
      const newItem = {
        id: itemId,
        text: text,
        category: category,
        checked: false,
        addedByUser: true,
      };
      
      state.items.push(newItem);
      if (!state.categories.includes(category)) {
        state.categories.push(category);
      }
      
      saveToLocalStorage();
      saveCheckedState(newItem);
      
      textInput.value = '';
      closeAddDialog();
      render();
      updateProgress();
    }
    
    // Share
    async function shareList() {
      const url = window.location.href;
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Shopping List â€“ ' + state.weekRange,
            text: 'Here's what we need!',
            url: url,
          });
        } catch (e) {
          if (e.name !== 'AbortError') copyToClipboard(url);
        }
      } else {
        copyToClipboard(url);
      }
    }
    
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => alert('Link copied!'));
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert('Link copied!');
      }
    }
    
    // Update progress
    function updateProgress() {
      const total = state.items.length;
      const checked = state.checkedItems.size;
      const pct = total > 0 ? (checked / total) * 100 : 0;
      
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressText').textContent = checked + ' of ' + total + ' grabbed';
    }
    
    // Render
    function render() {
      const container = document.getElementById('mainContent');
      
      if (state.items.length === 0) {
        container.innerHTML = '<div class="loading">Nothing on the list yet</div>';
        return;
      }
      
      let html = '';
      
      // Recipes
      if (state.schedule && state.schedule.length > 0) {
        html += '<div class="category-section">';
        html += '<div class="category-header">ðŸ“… Recipes This Week</div>';
        html += '<div style="padding-left: 4px;">';
        state.schedule.forEach(r => {
          html += '<div style="padding: 8px 0; font-size: 14px; color: hsl(var(--muted-foreground));">';
          html += '<strong>' + escapeHtml(r.recipe || r) + '</strong>';
          if (r.cook) html += ' - ' + escapeHtml(r.cook);
          if (r.day) html += ' (' + escapeHtml(r.day) + ')';
          html += '</div>';
        });
        html += '</div></div>';
      }
      
      // Group items
      const active = {};
      const completed = {};
      
      state.items.forEach(item => {
        const cat = item.category || 'Other';
        if (item.checked) {
          if (!completed[cat]) completed[cat] = [];
          completed[cat].push(item);
        } else {
          if (!active[cat]) active[cat] = [];
          active[cat].push(item);
        }
      });
      
      // Active items
      state.categories.forEach(cat => {
        if (!active[cat] || active[cat].length === 0) return;
        html += '<div class="category-section">';
        html += '<div class="category-header">' + escapeHtml(cat) + '</div>';
        active[cat].forEach(item => {
          html += '<div class="list-item" onclick="toggleItem(\'' + item.id + '\')">';
          html += '<div class="checkbox"></div>';
          html += '<div class="item-text">' + escapeHtml(item.text) + '</div>';
          html += '</div>';
        });
        html += '</div>';
      });
      
      // Completed
      const hasCompleted = Object.keys(completed).some(c => completed[c].length > 0);
      if (hasCompleted) {
        html += '<div class="completed-section">';
        html += '<div class="category-header">âœ“ Completed</div>';
        Object.keys(completed).forEach(cat => {
          if (!completed[cat] || completed[cat].length === 0) return;
          completed[cat].forEach(item => {
            html += '<div class="list-item checked" onclick="toggleItem(\'' + item.id + '\')">';
            html += '<div class="checkbox"></div>';
            html += '<div class="item-text">' + escapeHtml(item.text) + '</div>';
            html += '</div>';
          });
        });
        html += '</div>';
      }
      
      container.innerHTML = html;
      
      // Update category select
      const sel = document.getElementById('newItemCategory');
      if (sel) {
        sel.innerHTML = '<option value="">Select category...</option>';
        state.categories.forEach(c => {
          sel.innerHTML += '<option value="' + escapeHtml(c) + '">' + escapeHtml(c) + '</option>';
        });
      }
    }
    
    // Dialog
    function openAddDialog() {
      document.getElementById('addDialog').classList.add('show');
      document.getElementById('newItemText').focus();
    }
    
    function closeAddDialog(e) {
      if (e && e.target.id !== 'addDialog') return;
      document.getElementById('addDialog').classList.remove('show');
      document.getElementById('newItemText').value = '';
    }
    
    function handleAddItemKeydown(e) {
      if (e.key === 'Enter') addItem();
      else if (e.key === 'Escape') closeAddDialog();
    }
    
    // Offline
    function handleOffline() {
      state.offline = true;
      document.getElementById('offlineIndicator').classList.add('show');
    }
    
    function handleOnline() {
      state.offline = false;
      document.getElementById('offlineIndicator').classList.remove('show');
    }
    
    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Start
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

